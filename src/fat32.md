# AlienOS fat32

本文不仅将DBFS移植到Alien OS中，为了可以更直接查看内核中DBFS的性能，还移植了一个fat32文件系统，因为Alien OS中有一个类似linux 的VFS，因此fat32的移植会比较简单。本文编写了几个测试程序以测试两个文件系统是否正确工作，实验证明确实如此。在实现正确的基础上，本文编写了几个读写测试的程序。在顺序写测试中本文写入10MB大小的数据，在第一次写入时，DBFS会处理缺页异常将磁盘块的内容加载到内存中，fat32同样也会加载数据到内存中。在顺序读中，先写入10MB大小的数据，再将数据顺序读出。在随机读写测试中，首先写入16MB大小的数据，随后进行1000次的随机读取操作和1000次的随机写操作。



| (MB/s)/FS   |     DBFS |   FAT32 |
| :---------- | -------: | ------: |
| 顺序写(1MB) |   32MB/s |  15MB/s |
| 顺序写(Re)  |  384MB/s | 104MB/s |
| 顺序读(1MB) | 1000MB/s | 110MB/s |
| 顺序读(4KB) |   27MB/s |  50MB/s |
| 随机写(1MB) |  386MB/s |  56MB/s |
| 随机读(1MB) | 1066MB/s |  58MB/s |



表显示了在Alien中对DBFS和FAT32进行测试的结果。在读写大小1MB的情况下，DBFS相对于FAT32各种读写都具有较大的优势。其中顺序写最大是FAT32的4倍，顺序读最大是FAT32的10倍。DBFS的随机读写性能几乎保持各自保持一致。在读写大小为4K的情况下，DBFS的性能会下降，在顺序读稍弱于FAT32。

对于DBFS来说，本文设定了其存储粒度为32kb大小，在读写大小为1MB的情况下，每次读取只会查找32个键值对就可以完成数据读取，而对于fat32来说，由于其存储粒度只能设置为512B，因此读取时需要依次访问数千个块，这让1MB大小下DBFS具有更好的性能。当读写大小为4kb的情况下，数据库读取虽然每次只需要查找一个键值对，但总体的读取次数达到了数千次，频繁的索引反而降低了其性能，而对于FAT32,其数据几乎是连续存储，每次读取都只需要在前一次的基础上继续，综合下来，就导致了DBFS的性能下降。在表中第一行与第二行表现出不同的性能数据，这是因为第一行的测试是首次写入两个文件系统，因此内核会将磁盘数据加载到内存中，而第二行的写就只会在内存中完成。在随机读写中，DBFS表现出了与顺序读写相同的性能，而fat32性能下降了一半左右，因为fat32在随机读写中需要频繁地在分配表中线性查询数据位置，而DBFS依靠数据库的高效索引和特殊的设计，即使是随机读写，也同样具有更快的查找速度。
